apiVersion: v1
kind: ConfigMap
metadata:
  name: k6-script
data:
  test.js: |
    import http from 'k6/http';
    import { check, sleep } from 'k6';
    import { Rate } from 'k6/metrics';

    let errorRate = new Rate('errors');

    export let options = {
      scenarios: {
        ramp_to_1k_rps: {
          executor: 'ramping-arrival-rate',
          startRate: 10,             // start at 10 requests per second
          timeUnit: '1s',
          preAllocatedVUs: 100,      // VUs ready (adjust if needed)
          maxVUs: 2000,              // upper bound for scaling
          stages: [
            { target: 100, duration: '1m' },   // warm-up to 100 rps
            { target: 500, duration: '2m' },   // ramp to 500 rps
            { target: 1000, duration: '2m' },  // ramp to 1k rps
            { target: 1000, duration: '3m' },  // sustain at 1k rps
            { target: 0, duration: '1m' },     // graceful ramp-down
          ],
        },
      },
      thresholds: {
        http_req_duration: ['p(95)<500'], // 95% of requests < 500ms
        http_req_failed: ['rate<0.1'],    // less than 10% failure
        errors: ['rate<0.1'],
      },
    };

    const BASE_URL = 'http://backend:8080';

    export default function () {
      const email = `auth_${Date.now()}_${Math.floor(Math.random() * 1e9)}@test.com`;
      const password = 'TestPass123!';

      // Signup
      let res = http.post(`${BASE_URL}/auth/signup`, JSON.stringify({
        firstname: 'Auth',
        lastname: 'User',
        email: email,
        password: password,
        phone: '1234567890'
      }), { headers: { 'Content-Type': 'application/json' } });

      check(res, { 'signup 200': r => r.status === 200 }) || errorRate.add(1);

      // Login
      res = http.post(`${BASE_URL}/auth/login`, JSON.stringify({ email, password }), {
        headers: { 'Content-Type': 'application/json' }
      });

      check(res, { 'login 200': r => r.status === 200 }) || errorRate.add(1);

      sleep(0.5);
    }
